############################################
ALLIANCE SYSTEM
PRODUCTION SPEC v3.0
STATUS: DESIGN FREEZE
############################################


========================================================
0. CORE PRINCIPLES
========================================================

- Deterministic behavior
- No implicit destructive actions
- All structural mutations are journaled
- Lock hierarchy enforced
- Community continuity over automation
- Manual authority over automatic deletion
- SAFE_MODE protects structure, not conversation


========================================================
1. SYSTEM LAYERS (HARD BOUNDARIES)
========================================================

1.1 ENGINE LAYER
- Scheduler
- Dispatcher
- Session Manager
- Renderer
- No business logic
- No permission logic
- No database mutation

1.2 FEATURE MODULES
- Alliance
- Reminders
- Tiles Survival
- Core
- Help
- Cannot mutate database directly
- Cannot perform structural Discord operations directly

1.3 SYSTEM LAYER
- The ONLY mutation authority
- Executes destructive operations
- Executes structural changes
- Handles locks
- Handles journal

1.4 DATA LAYER
- No business rules
- Structured storage only
- Deterministic read/write


========================================================
2. OWNERSHIP MODEL
========================================================

2.1 BOT OWNER
- Single
- Transferable via strict protocol
- Cannot transfer during SAFE_MODE
- Cannot transfer if health != HEALTHY
- Transfer requires:
    - Global Lock
    - Journal entry
    - 2-step confirmation

2.2 DISCORD OWNER
- Single
- Governance authority only
- Cannot modify infrastructure
- Can create/delete alliances


========================================================
3. ALLIANCE MODEL
========================================================

3.1 ROLES
- R5 (Leader)
- R4 (Moderator)
- R3 (Member)
- Identity Role (ping-only, no permissions)

3.2 LIMITS
- Max 100 members total
- Max 10 R4 moderators

3.3 PERMISSIONS
- R5:
    - Promote R4
    - Promote R3
    - Kick R4
    - Kick R3

- R4:
    - Kick R3 only

3.4 DELETION
- Only via explicit slash command
- Requires 2-step confirmation
- Requires Journal
- Requires Global Lock
- Never auto-delete


========================================================
4. ORPHAN STATE
========================================================

Triggered when:
- No R5
AND
- No R4
AND
- No R3

Effects:
- Governance disabled
- No promotions
- No moderator actions
- Alliance remains intact
- No auto deletion

Recovery:
- Bot Owner or Discord Owner assigns new R5
- Journal required


========================================================
5. MUTATION PROTOCOL
========================================================

Every structural mutation MUST:

1. Acquire lock
2. Validate permissions
3. Validate state
4. Write Journal (PENDING)
5. Execute atomically
6. Update Journal (EXECUTED → CONFIRMED)
7. Release lock

If journal write fails → abort.

No partial execution allowed.


========================================================
6. LOCK HIERARCHY
========================================================

Global Lock
   ↓
Alliance Lock
   ↓
User Lock (optional)

Violating order is forbidden.

Lock timeout:
- Abort mutation
- Log warning
- Never force unlock blindly


========================================================
7. JOURNAL SYSTEM
========================================================

Every governance mutation must log:

- timestamp
- operation
- actor
- target
- alliance_id
- pre_state_hash

Statuses:
- PENDING
- EXECUTED
- CONFIRMED
- ABORTED

On crash:
- Replay PENDING deterministically
- Must be idempotent


========================================================
8. HEALTH SYSTEM (HYBRID MODEL)
========================================================

States:

- HEALTHY
- WARNING
- DEGRADED
- ERROR
- CRITICAL
- SAFE_MODE

Health Layer may:
- Monitor invariants
- Detect inconsistencies
- Trigger repair request

Health Layer may NOT:
- Directly mutate data
- Directly delete alliance
- Directly change ownership

Repair model:
- Health emits REPAIR_REQUEST
- System Layer executes repair
- Lock + Journal required
- Retry limit enforced
- Escalate to CRITICAL if exceeded

SAFE_MODE overrides all.


========================================================
9. SAFE_MODE
========================================================

Triggered by:
- Bot Owner missing
- Critical invariant violation
- Severe corruption risk
- Manual activation

Blocked:
- create alliance
- delete alliance
- ownership transfer
- R5/R4/R3 structural changes
- migration
- destructive repair

Allowed:
- join alliance
- leave alliance
- read-only commands
- health inspection
- logs
- restore (Bot Owner only)

Exit:
- Bot Owner only
- Explicit command
- Journal entry
- Not allowed if CRITICAL


========================================================
10. BACKUP & RESTORE
========================================================

Backup:
- Snapshot
- SHA256 hash
- HMAC signature
- Secret rotation supported

Restore:
- Only in SAFE_MODE
- Validate signature
- Validate schema
- Validate structure


========================================================
11. CONCURRENCY GUARANTEES
========================================================

Leader transition:
- Lock protected
- Journaled
- Deterministic
- No double promotion possible

Simultaneous promote/kick:
- One succeeds
- One fails cleanly
- No undefined state


========================================================
12. PROHIBITED BEHAVIOR
========================================================

Forbidden:

- Direct DB writes from feature modules
- Direct structural Discord changes from feature modules
- Skipping journal
- Auto-delete alliance
- Auto SAFE_MODE exit
- Silent mutation without logging


========================================================
13. MINIMUM TEST REQUIREMENTS
========================================================

Before production deploy:

- Crash recovery test
- Journal replay test
- Leader race condition test
- Two-step delete test
- Corrupted backup test
- SAFE_MODE freeze test
- Lock timeout test
- Orphan alliance recovery test


========================================================
END OF PRODUCTION SPEC v3.0
DESIGN FROZEN
READY FOR IMPLEMENTATION
========================================================