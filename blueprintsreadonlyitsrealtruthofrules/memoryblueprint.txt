# BOT_V3_MASTER_MEMORY
Canonical Version: v1.0
Date: 2026-02-23
Project: bot-v3 (Discord Production Architecture v3)

============================================================
1. PROJECT STATE
============================================================

Status: ENGINE STABLE – FEATURE LAYER IN PROGRESS

Engine layer hardened and tested.
Feature layer (Alliance + OwnerModule) under structured expansion.

GitHub Tree API (source of truth for structure):
https://api.github.com/repos/avrhxxx/bot-v3/git/trees/main?recursive=1


============================================================
2. CORE ENGINE STATUS
============================================================

STABLE MODULES:

- Dispatcher
  - SafeMode guard
  - Health guard
  - Global error boundary
- MutationGate
  - GlobalLock
  - AllianceLock
- SnapshotService
- IntegrityMonitor (async, overlap-safe)
- RepairService (wrapped in MutationGate)
- Journal (command failure logging)
- SafeMode
- Health (CRITICAL blocking works)
- Boot verification hardened

ENGINE TESTS PASSED:

- Boot Clean Start
- SafeMode Block
- CRITICAL Block
- Forced Command Error
- Integrity Escalation

Engine = production-ready foundation.


============================================================
3. ALLIANCE MODEL V2 (APPROVED)
============================================================

Alliance structure:

- guildId
- tag (exactly 3 characters, alphanumeric only)
- name
- members:
    - r5 (single)
    - r4[]
    - r3[]
- roles:
    - r5RoleId
    - r4RoleId
    - r3RoleId
    - identityRoleId
- channels:
    - categoryId
    - leadershipChannelId
    - officersChannelId
    - membersChannelId
    - joinChannelId
- orphaned (boolean)
- createdAt

Join channel is per-alliance.


============================================================
4. ALLIANCE DOMAIN RULES
============================================================

- Tag must be exactly 3 alphanumeric characters.
- Tag must be unique within guild.
- One user → one alliance.
- Role exclusivity:
    R5 OR R4 OR R3 (never multiple).
- Exactly one R5 per alliance.
- AllianceService is domain-pure (no Discord mutations).
- Discord mutations allowed only in System layer.
- Infrastructure creation must be atomic with rollback.
- No orphaned Discord artifacts allowed.


============================================================
5. ALLIANCE CREATION FLOW
============================================================

1. Slash command invoked (/x alliance create)
2. System layer:
   - Create category
   - Create channels
   - Create roles
3. Assign leader:
   - R5 role
   - Identity role
4. Persist domain model via AllianceService
5. Integrity snapshot


============================================================
6. COMMAND ARCHITECTURE
============================================================

All commands use prefix:
    /x <namespace>

Namespaces:

- /x sys ...
- /x alliance ...

First root system command:
    /x sys setup

Future:
- Command Autoloader


============================================================
7. OWNER MODULE (MVP PLAN)
============================================================

Execution order:

1. OwnerModule (minimal viable implementation)
2. /x sys setup
3. Unique BotOwner
4. Unique DiscordOwner
5. OwnerGuard middleware
6. AllianceCreate (owner-only beta)
7. Command Autoloader
8. TimeModule
9. Demo readiness

OwnerModule responsibilities:

- Manage unique BotOwner
- Manage unique DiscordOwner
- Guard system-level commands
- Escalate to SafeMode on critical ownership violations


============================================================
8. WORKFLOW RULES
============================================================

MANDATORY:

- Always request full file before modification.
- Always return full 1:1 file replacement.
- Perform integrity check after major changes.
- Architecture → Orchestration → Domain purity → Iteration.
- Proactively suggest safest implementation order.
- No refactor unless necessary.
- Blueprint update before data model changes.

Externalized state approach:
This file is the canonical memory.
ChatGPT internal memory is NOT relied upon.


============================================================
9. BLUEPRINT V3 – MISSING COMPONENTS
============================================================

Not yet implemented:

- Scheduler
- SessionManager
- Renderer
- Full Health state machine
- Journal replay on boot
- Persistent storage
- Extended backup integrity


============================================================
10. CURRENT PRIORITY ROADMAP
============================================================

1. Repo skeleton alignment (confirmed via GitHub Tree API)
2. OwnerModule MVP
3. /x sys setup
4. OwnerGuard integration in Dispatcher
5. AllianceCreate command (owner-only beta)
6. Command Autoloader
7. TimeModule
8. Demo scenario validation


============================================================
END OF MASTER MEMORY v1.0
============================================================

============================================================
WORKFLOW CONTROL UPDATE (2026-02-23)
============================================================

Execution Mode: Guided Command Mode

- Assistant MUST always suggest the next safest architectural step.
- User only confirms or rejects the proposed step.
- No free-form drifting.
- No unordered implementation.
- No jumping layers.

Implementation Strategy for Beta (5h Window):

Goal: Deploy working Beta bot.

Scope includes:
- OwnerModule MVP
- /x sys setup
- OwnerGuard integration
- AllianceCreate command
- TimeModule
- Command Autoloader
- Full integrity verification
- Raw Discord server tests

Rule:
Assistant defines next step.
User confirms.
Then implementation proceeds.

============================================================

============================================================
OWNER BOOTSTRAP RULE (2026-02-23)
============================================================

Command: /x sys setup

Bootstrap logic:

IF BotOwner does NOT exist:
    - Allow execution only if user has Discord Administrator permission.
    - Initialize Ownership with:
        botOwnerId = user.id
        discordOwnerId = guild.ownerId

ELSE:
    - Command requires ownerOnly access.

XsysCommand removed (legacy structure cleanup).
OwnerGuard implemented in Dispatcher via ownerOnly flag.
============================================================