graph TD
  %% ----------------- Core System -----------------
  subgraph SYSTEM ["src/system"]
    Health["Health.ts"]
    Ownership["Ownership.ts"]
    SafeMode["SafeMode.ts"]
    TimeModule["TimeModule/TimeModule.ts"]
    OwnerModule["OwnerModule/OwnerModule.ts"]  %% nowy

    subgraph ALLIANCE_SYS ["alliance"]
      AllianceSystem["AllianceSystem.ts"]
      TransferLeaderSystem["TransferLeaderSystem.ts"]
      
      subgraph RoleMod ["RoleModule"]
        RoleModuleTS["RoleModule.ts"]
      end
      subgraph ChannelMod ["ChannelModule"]
        ChannelModuleTS["ChannelModule.ts"]
      end
      subgraph BroadcastMod ["BroadcastModule"]
        BroadcastModuleTS["BroadcastModule.ts"]
      end
      subgraph CommandDisp ["CommandDispatcher"]
        CommandDispatcherTS["CommandDispatcher.ts"]
      end
    end

    subgraph SNAPSHOT ["snapshot"]
      IntegrityMonitor["IntegrityMonitor.ts"]
      RepairService["RepairService.ts"]
      SnapshotService["SnapshotService.ts"]
      SnapshotTypes["SnapshotTypes.ts"]
    end
  end

  %% ----------------- Engine -----------------
  subgraph ENGINE ["src/engine"]
    Dispatcher["Dispatcher.ts"]
    MutationGate["MutationGate.ts"]
  end

  %% ----------------- Features -----------------
  subgraph FEATURES ["src/features"]
    subgraph ALLIANCE_FEAT ["alliance"]
      AllianceService["AllianceService.ts"]
      AllianceTypes["AllianceTypes.ts"]
      
      subgraph INTEGRITY ["integrity"]
        AllianceIntegrity["AllianceIntegrity.ts"]
      end
      subgraph ORCHESTRATION ["orchestration"]
        AllianceCreationOrchestrator["AllianceCreationOrchestrator.ts"]
      end
    end
  end

  %% ----------------- Commands -----------------
  subgraph COMMANDS ["src/commands"]
    CommandTS["Command.ts"]
    CommandRegistry["CommandRegistry.ts"]
    CommandLoader["CommandLoader.ts"]
    
    subgraph ALLIANCE_CMDS ["alliance"]
      demote["demote.ts"]
      join["join.ts"]
      kick["kick.ts"]
      leave["leave.ts"]
      promote["promote.ts"]
      transferLeader["transferLeader.ts"]
      updateName["updateName.ts"]
      updateTag["updateTag.ts"]
    end
    
    subgraph SYS_CMDS ["sys"]
      allianceCreate["allianceCreate.ts"]
      allianceDelete["allianceDelete.ts"]
      setLeader["setLeader.ts"]
      setup["setup.ts"]
    end
  end

  %% ----------------- Data -----------------
  subgraph DATA ["src/data"]
    Database["Database.ts"]
    Repositories["Repositories.ts"]
  end

  %% ----------------- Discord -----------------
  subgraph DISCORD ["src/discord"]
    Client["client.ts"]
  end

  %% ----------------- Journal -----------------
  subgraph JOURNAL ["src/journal"]
    JournalTS["Journal.ts"]
    JournalTypesTS["JournalTypes.ts"]
  end

  %% ----------------- Locks -----------------
  subgraph LOCKS ["src/locks"]
    AllianceLock["AllianceLock.ts"]
    GlobalLock["GlobalLock.ts"]
  end

  %% ----------------- Connections -----------------
  %% Commands → Dispatcher
  CommandTS --> CommandDispatcherTS
  CommandRegistry --> CommandDispatcherTS
  CommandLoader --> CommandDispatcherTS
  demote --> CommandDispatcherTS
  join --> CommandDispatcherTS
  kick --> CommandDispatcherTS
  leave --> CommandDispatcherTS
  promote --> CommandDispatcherTS
  transferLeader --> CommandDispatcherTS
  updateName --> CommandDispatcherTS
  updateTag --> CommandDispatcherTS
  allianceCreate --> CommandDispatcherTS
  allianceDelete --> CommandDispatcherTS
  setLeader --> CommandDispatcherTS
  setup --> CommandDispatcherTS

  %% Dispatcher → Engine
  CommandDispatcherTS --> Dispatcher
  Dispatcher --> MutationGate

  %% Alliance System dependencies
  AllianceSystem --> RoleModuleTS
  AllianceSystem --> ChannelModuleTS
  AllianceSystem --> BroadcastModuleTS
  AllianceSystem --> LOCKS
  TransferLeaderSystem --> AllianceSystem
  TransferLeaderSystem --> RoleModuleTS

  %% Features use system
  AllianceService --> AllianceSystem
  AllianceService --> AllianceIntegrity
  AllianceService --> AllianceCreationOrchestrator
  AllianceCreationOrchestrator --> RoleModuleTS
  AllianceCreationOrchestrator --> ChannelModuleTS
  AllianceCreationOrchestrator --> BroadcastModuleTS

  %% Database & Repositories
  AllianceSystem --> Database
  AllianceService --> Repositories

  %% Discord
  CommandDispatcherTS --> Client

  %% Journal
  AllianceSystem --> JournalTS
  AllianceSystem --> JournalTypesTS

  %% Snapshot
  IntegrityMonitor --> Database
  RepairService --> IntegrityMonitor
  SnapshotService --> IntegrityMonitor

  %% OwnerModule connections
  OwnerModule --> CommandDispatcherTS
  setup --> OwnerModule